@attribute [Route(GtgrRoutes.TagOverview)]
@inherits GtgrPage
@using GeoTaggr.Core.Countries
@using GeoTaggr.Core.Extensions
@using GeoTaggr.Core.Tags
@using GeoTaggr.Data.Tags
@using GeoTaggr.Services
@using GeoTaggr.Services.Countries
@using GeoTaggr.Services.Tags
@using GeoTaggr.Web.Components.Shared.Breadcrumbs
@using GeoTaggr.Web.Components.Shared.Forms.Selects
@using GeoTaggr.Web.Components.Shared.Maps
@using GeoTaggr.Web.Components.Shared.Pages

<GtgrPageLayout Title="Tag overview" Breadcrumbs="@Breadcrumbs">    
    <Content>
        <GtgrWidgetContainer>
            <TagSummaryTable Tags="@Tags"></TagSummaryTable>
        </GtgrWidgetContainer>
    </Content>
</GtgrPageLayout>

@inject ICountryService CountryService
@inject ITagService TagService
@code {
    private IReadOnlyCollection<GtgrBreadcrumbItem> Breadcrumbs = new[]
    {
        new GtgrBreadcrumbItem("Tags") { Url = GtgrRoutes.Tags },
        new GtgrBreadcrumbItem("Overview") { Active = true }
    };

    private IReadOnlyDictionary<int, Country>? Countries { get; set; }

    private IReadOnlyCollection<Tag>? Tags { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await LoadCountriesAsync();
        await LoadTagsAsync();
    }

    private async Task LoadCountriesAsync()
    {
        Countries = await CountryService.GetCountryDictionaryAsync(new CountryFilterValues
        {
            IncludeNoCoverage = false
        });
    }

    private async Task LoadTagsAsync()
    {
        Tags = null;
        if (UserId == null)
        {
            return;
        }

        Tags = await TagService.GetTagsAsync(new TagFilter(UserId.Value));
    }

    private async Task OnTagDelete(int tagId)
    {
        if (UserId == null)
        {
            return;
        }

        ServiceResult result = await TagService.DeleteTagAsync(tagId, UserId.Value);
        if (result.Success)
        {
            await LoadTagsAsync();
        }
    }

    private async Task OnTagCreated()
    {
        await LoadTagsAsync();
    }
}
